<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes - FreeLearning</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            margin-bottom: 2rem;
            text-align: center;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .new-note-form {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .new-note-form textarea {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }

        .new-note-form textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 600;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .notes-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .sticky-note {
            background: #fef3c7;
            padding: 1.5rem;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid #f59e0b;
        }

        .sticky-note:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.1);
        }

        .sticky-note.editing {
            background: #fff7ed;
        }

        .note-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #78350f;
            font-size: 1rem;
            line-height: 1.6;
            cursor: pointer;
            min-height: 40px;
        }

        .note-content:hover {
            color: #92400e;
        }

        .note-textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.5rem;
            border: 2px solid #f59e0b;
            border-radius: 4px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            background: white;
            color: #78350f;
        }

        .note-textarea:focus {
            outline: none;
            border-color: #d97706;
        }

        .note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid #fbbf24;
            font-size: 0.875rem;
            color: #92400e;
        }

        .note-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 500;
        }

        .btn-small:hover {
            background: #d97706;
        }

        .btn-small.secondary {
            background: #94a3b8;
        }

        .btn-small.secondary:hover {
            background: #64748b;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            padding: 2rem;
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border-left: 4px solid #dc2626;
        }

        .empty-state {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            padding: 3rem;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <div class="container" x-data="notesApp()">
        <h1>My Notes</h1>

        <div x-show="error" x-text="error" class="error"></div>

        <div class="new-note-form">
            <textarea
                x-model="newNoteText"
                placeholder="Write a new note..."
                @keydown.ctrl.enter="createNote()"
            ></textarea>
            <button
                class="btn"
                @click="createNote()"
                :disabled="!newNoteText.trim() || creating"
                x-text="creating ? 'Creating...' : 'Add Note'"
            ></button>
        </div>

        <div x-show="loading" class="loading">Loading notes...</div>

        <div x-show="!loading && notes.length === 0" class="empty-state">
            No notes yet. Create your first note above!
        </div>

        <div class="notes-container">
            <template x-for="note in notes" :key="note.id">
                <div class="sticky-note" :class="{ 'editing': editingId === note.id }">
                    <div x-show="editingId !== note.id"
                         @click="startEdit(note)"
                         class="note-content"
                         x-text="note.data.text"></div>

                    <div x-show="editingId === note.id">
                        <textarea
                            x-model="editText"
                            class="note-textarea"
                            @keydown.escape="cancelEdit()"
                            x-ref="editTextarea"
                        ></textarea>
                        <div class="note-actions" style="margin-top: 0.5rem;">
                            <button
                                class="btn-small"
                                @click="saveEdit(note)"
                                :disabled="saving"
                                x-text="saving ? 'Saving...' : 'Save'"
                            ></button>
                            <button
                                class="btn-small secondary"
                                @click="cancelEdit()"
                                :disabled="saving"
                            >Cancel</button>
                        </div>
                    </div>

                    <div class="note-meta" x-show="editingId !== note.id">
                        <span x-text="formatDate(note.created_at)"></span>
                        <span x-show="note.updated_at !== note.created_at"
                              x-text="'Updated: ' + formatDate(note.updated_at)"></span>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <script>
        function notesApp() {
            return {
                notes: [],
                loading: false,
                creating: false,
                saving: false,
                error: null,
                newNoteText: '',
                editingId: null,
                editText: '',
                apiUrl: 'http://localhost:8080',

                async init() {
                    await this.loadNotes();
                },

                async loadNotes() {
                    this.loading = true;
                    this.error = null;
                    try {
                        const response = await fetch(`${this.apiUrl}/entities`);
                        if (!response.ok) throw new Error('Failed to load notes');

                        const allEntities = await response.json();
                        this.notes = allEntities
                            .filter(entity => entity.kind === 'freelearning.org/Note')
                            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    } catch (err) {
                        this.error = 'Error loading notes: ' + err.message;
                        console.error('Error loading notes:', err);
                    } finally {
                        this.loading = false;
                    }
                },

                async createNote() {
                    if (!this.newNoteText.trim()) return;

                    this.creating = true;
                    this.error = null;
                    try {
                        const response = await fetch(`${this.apiUrl}/entities`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                kind: 'freelearning.org/Note',
                                version: '1.0.0',
                                data: {
                                    text: this.newNoteText
                                }
                            })
                        });

                        if (!response.ok) throw new Error('Failed to create note');

                        const newNote = await response.json();
                        this.notes.unshift(newNote);
                        this.newNoteText = '';
                    } catch (err) {
                        this.error = 'Error creating note: ' + err.message;
                        console.error('Error creating note:', err);
                    } finally {
                        this.creating = false;
                    }
                },

                startEdit(note) {
                    this.editingId = note.id;
                    this.editText = note.data.text;
                    this.$nextTick(() => {
                        this.$refs.editTextarea?.focus();
                    });
                },

                cancelEdit() {
                    this.editingId = null;
                    this.editText = '';
                },

                async saveEdit(note) {
                    if (!this.editText.trim()) return;

                    this.saving = true;
                    this.error = null;
                    try {
                        const response = await fetch(`${this.apiUrl}/entities/${note.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                data: {
                                    text: this.editText
                                }
                            })
                        });

                        if (!response.ok) throw new Error('Failed to update note');

                        const updatedNote = await response.json();
                        const index = this.notes.findIndex(n => n.id === note.id);
                        if (index !== -1) {
                            this.notes[index] = updatedNote;
                        }
                        this.editingId = null;
                        this.editText = '';
                    } catch (err) {
                        this.error = 'Error updating note: ' + err.message;
                        console.error('Error updating note:', err);
                    } finally {
                        this.saving = false;
                    }
                },

                formatDate(dateString) {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);

                    if (diffMins < 1) return 'Just now';
                    if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
                    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                    if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;

                    return date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
                    });
                }
            }
        }
    </script>
</body>
</html>
